<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Roasting Log</title>
<style>
  :root { --bg:#0f1115; --card:#151823; --muted:#8b92a6; --text:#e8ecf3; --accent:#5cc8ff; --accent2:#52d39b; --warn:#ffb656; --danger:#ff6b6b; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:1100px;margin:0 auto;padding:20px;}
  .tabs{display:flex;gap:10px;margin-bottom:16px;position:sticky;top:0;background:var(--bg);padding-top:8px;z-index:2}
  .tab{flex:0 0 auto;padding:10px 14px;border-radius:12px;background:#1b2030;color:var(--muted);border:1px solid #23283b;cursor:pointer}
  .tab.active{color:var(--text);border-color:var(--accent);box-shadow:0 0 0 2px #1a2735}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{grid-column:1/-1;background:var(--card);border:1px solid #20263a;border-radius:16px;padding:16px}
  h2{margin:0 0 12px 0;font-size:20px}
  .row{display:flex;flex-wrap:wrap;gap:10px}
  .field{display:flex;flex-direction:column;gap:6px;min-width:140px}
  label{font-size:13px;color:var(--muted)}
  input,select,textarea{background:#101420;color:var(--text);border:1px solid #23283b;border-radius:12px;padding:12px;font-size:16px;outline:none}
  input:focus,textarea:focus,select:focus{border-color:var(--accent)}
  textarea{min-height:72px;resize:vertical}
  .btns{display:flex;flex-wrap:wrap;gap:10px}
  .btn{padding:14px 16px;border-radius:14px;border:1px solid #2a324c;background:#121726;color:var(--text);font-size:16px;cursor:pointer;touch-action:manipulation}
  .btn:active{transform:translateY(1px)}
  .btn.accent{border-color:#24465a;background:#0f1b26}
  .btn.accent2{border-color:#255044;background:#0f1e19}
  .btn.warn{border-color:#4b3b1f;background:#19140c}
  .btn.danger{border-color:#4a1f27;background:#190d10}
  .btn.small{padding:8px 10px;font-size:14px;border-radius:10px}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #2a324c;background:#121726;color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{padding:10px 12px;text-align:left;font-size:14px}
  thead th{color:var(--muted);font-weight:600}
  tbody tr{background:#121726;border:1px solid #1f2639}
  tbody td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  td[contenteditable="true"]{outline:0;border-bottom:1px dashed #2a324c}
  .right{justify-content:flex-end;margin-left:auto}
  .split{display:flex;gap:12px;flex-wrap:wrap}
  .grow{flex:1}
  .hint{font-size:12px;color:var(--muted)}
  .sticky-actions{position:sticky;bottom:0;padding-top:10px;background:linear-gradient(180deg, rgba(15,17,21,0), var(--bg) 40%);}
  /* --- Detail modal --- */
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50;padding:16px}
  .modal-card{width:min(920px,96vw);max-height:92vh;overflow:auto;background:#151823;border:1px solid #20263a;border-radius:16px;padding:16px}
  .modal-head{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .modal-head h3{margin:0;font-size:18px}
  .modal-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .modal-grid .field{grid-column:span 6}
  .modal-grid .field.wide{grid-column:1 / -1}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;position:sticky;bottom:0;background:linear-gradient(180deg, rgba(21,24,35,0), #151823 40%);padding-top:10px;margin-top:12px}
  .badge{padding:4px 8px;border-radius:999px;border:1px solid #2a324c;background:#121726;color:#8b92a6;font-size:12px}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- Detail Modal -->
<div id="detailModal" class="modal-bg" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
  <div class="modal-card">
    <div class="modal-head">
      <h3 id="detailTitle">Roast Details</h3>
      <span id="detailId" class="badge"></span>
      <span id="detailStorage" class="badge"></span>
      <button id="detailClose" class="btn small right">Close</button>
    </div>

    <div class="modal-grid">
      <div class="field"><label>Date</label><input id="d_date" /></div>
      <div class="field"><label>Roaster</label><input id="d_roaster" /></div>
      <div class="field"><label>Bean / Lot</label><input id="d_bean" /></div>
      <div class="field"><label>Profile</label><input id="d_profile" /></div>
      <div class="field"><label>Starting Weight (g)</label><input id="d_startWeight" type="number" inputmode="decimal" /></div>
      <div class="field"><label>Charge Temp (°C)</label><input id="d_chargeTemp" type="number" inputmode="decimal" /></div>

      <div class="field"><label>Start Time</label>
        <input id="d_startTime" placeholder="auto or ISO" />
        <div class="btns" style="margin-top:6px"><button id="d_setStartNow" class="btn small">Set to now</button></div>
      </div>

      <div class="field"><label>1st Crack Time</label>
        <input id="d_firstCrackTime" placeholder="auto or ISO" />
        <div class="btns" style="margin-top:6px"><button id="d_setFCNow" class="btn small">Set to now</button></div>
      </div>
      <div class="field"><label>1st Crack Temp (°C)</label><input id="d_firstCrackTemp" type="number" inputmode="decimal" /></div>

      <div class="field"><label>2nd Crack Time</label>
        <input id="d_secondCrackTime" placeholder="auto or ISO" />
        <div class="btns" style="margin-top:6px"><button id="d_setSCNow" class="btn small">Set to now</button></div>
      </div>
      <div class="field"><label>2nd Crack Temp (°C)</label><input id="d_secondCrackTemp" type="number" inputmode="decimal" /></div>

      <div class="field"><label>Finish Time</label>
        <input id="d_endTime" placeholder="auto or ISO" />
        <div class="btns" style="margin-top:6px"><button id="d_setEndNow" class="btn small">Set to now</button></div>
      </div>
      <div class="field"><label>End Weight (g)</label><input id="d_endWeight" type="number" inputmode="decimal" /></div>
      <div class="field"><label>End Temp (°C)</label><input id="d_endTemp" type="number" inputmode="decimal" /></div>

      <div class="field wide"><label>Notes</label><textarea id="d_notes" placeholder="Add notes, observations, changes..."></textarea></div>
    </div>

    <div class="modal-actions">
      <button id="detailDelete" class="btn small danger">Delete</button>
      <button id="detailDuplicate" class="btn small">Duplicate</button>
      <button id="detailSave" class="btn small accent2">Save Changes</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="tabs">
    <button class="tab active" data-tab="active">Active Roast</button>
    <button class="tab" data-tab="log">Roast Log</button>
    <span class="pill" id="status-pill">Ready</span>
    <div class="right split">
      <button class="tab btn small" id="orderQueueTab">Order Queue</button>
      <span id="authStatus" class="pill">Not signed in</span>
      <button class="tab btn small" id="btnSignIn">Sign in</button>
      <button class="tab btn small" id="btnSignOut" style="display:none;">Sign out</button>
      <button class="tab btn small" id="exportCsv">Export CSV</button>
      <label class="tab btn small" style="cursor:pointer">Import CSV
        <input id="importCsv" type="file" accept=".csv" style="display:none" />
      </label>
    </div>
  </div>

  <!-- Active Roast -->
  <div id="tab-active">
    <div class="card">
      <h2>Batch Details</h2>
      <div class="row">
        <div class="field"><label>Roaster</label><input id="roasterName" placeholder="Who is roasting?" /></div>
        <div class="field"><label>Bean / Lot</label><input id="beanName" placeholder="e.g., Ethiopia Yirgacheffe" /></div>
        <div class="field"><label>Starting Weight (g)</label><input id="startWeight" type="number" inputmode="decimal" placeholder="e.g., 1000" /></div>
        <div class="field"><label>Charge Temp (°C)</label><input id="chargeTemp" type="number" inputmode="decimal" placeholder="optional" /></div>
        <div class="field"><label>Drum / Profile</label><input id="profile" placeholder="optional notes" /></div>
        <div class="field grow"><label>Notes</label><input id="notes" placeholder="Anything special for this batch" /></div>
      </div>
    </div>

    <div class="card">
      <h2>Capture Timeline</h2>
      <div class="btns">
        <button class="btn accent" id="btnStart">Start</button>
        <div class="field">
          <label>Start Time</label>
          <input id="startTime" placeholder="auto" readonly />
        </div>
      </div>
      <div class="btns" style="margin-top:8px">
        <button class="btn accent2" id="btnFC">1st Crack</button>
        <div class="field">
          <label>1C Time</label>
          <input id="firstCrackTime" placeholder="auto" readonly />
        </div>
        <div class="field">
          <label>1C Temp (°C)</label>
          <input id="firstCrackTemp" type="number" inputmode="decimal" placeholder="enter temp" />
        </div>
      </div>
      <div class="btns" style="margin-top:8px">
        <button class="btn warn" id="btnSC">2nd Crack</button>
        <div class="field">
          <label>2C Time</label>
          <input id="secondCrackTime" placeholder="auto" readonly />
        </div>
        <div class="field">
          <label>2C Temp (°C)</label>
          <input id="secondCrackTemp" type="number" inputmode="decimal" placeholder="enter temp" />
        </div>
      </div>
      <div class="btns" style="margin-top:8px">
        <button class="btn danger" id="btnEnd">Finish</button>
        <div class="field">
          <label>End Time</label>
          <input id="endTime" placeholder="auto" readonly />
        </div>
        <div class="field">
          <label>End Weight (g)</label>
          <input id="endWeight" type="number" inputmode="decimal" placeholder="e.g., 850" />
        </div>
        <div class="field">
          <label>End Temp (°C)</label>
          <input id="endTemp" type="number" inputmode="decimal" placeholder="enter temp" />
        </div>
      </div>

      <div class="sticky-actions btns" style="margin-top:14px">
        <button class="btn small" id="btnReset">Reset</button>
        <button class="btn small accent2" id="btnSave">Save Roast</button>
        <span class="hint" id="deltaHint"></span>
      </div>
    </div>
  </div>

  <!-- Roast Log -->
  <div id="tab-log" style="display:none">
    <div class="card">
      <h2>All Roasts</h2>
      <div class="hint" style="margin-bottom:8px">Tap cells to edit inline. Changes are saved automatically.</div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Batch ID</th>
              <th>Date</th>
              <th>Roaster</th>
              <th>Bean</th>
              <th>Start</th>
              <th>1C (t / °C)</th>
              <th>2C (t / °C)</th>
              <th>Finish</th>
              <th>Start g</th>
              <th>End g</th>
              <th>End °C</th>
              <th>Loss %</th>
              <th>Notes</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="logTbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div id="tab-orders" style="display:none">
  <div class="card">
    <h2>Order Queue</h2>
    <div class="hint">New web orders appear here automatically after you sign in.</div>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>When</th>
            <th>Order #</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Notes</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="ordersTbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* =================== Supabase setup =================== */
const SUPABASE_URL  = "https://spdzolnriqpyoupnwdvq.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwZHpvbG5yaXFweW91cG53ZHZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMjU4NTUsImV4cCI6MjA3MDYwMTg1NX0.uYH2jwqCGCqW5Qo7FpuwQg6Z7kPbotVuLpjJm8xA-3M";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* =================== UI helpers =================== */
const $  = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const authStatus     = $('#authStatus');
const btnSignIn      = $('#btnSignIn');
const btnSignOut     = $('#btnSignOut');
const ordersTabButton= $('#orderQueueTab');
const statusPill     = $('#status-pill');

const fmtTime = d => d ? new Date(d).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '';
const nowISO  = () => new Date().toISOString();
const todayStr= () => new Date().toLocaleDateString();

function showTab(name){
  $('#tab-active').style.display = name==='active' ? 'block' : 'none';
  $('#tab-log').style.display    = name==='log'    ? 'block' : 'none';
  $('#tab-orders').style.display = name==='orders' ? 'block' : 'none';
}

function uiError(where, error){
  const msg = (error?.message || error || '').toString();
  console.error(where + ':', error);
  statusPill.textContent = `${where} error: ${msg}`;
  alert(`${where} error:\n${msg}`);
}

/* =================== Realtime channels =================== */
let ordersChannel = null;
let roastingChannel = null;

function startOrdersRealtime(){
  if (ordersChannel) return;
  ordersChannel = sb.channel('orders-realtime')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'order_queue' }, () => {
      loadOrders();
    })
    .subscribe();
}
function stopOrdersRealtime(){
  if (ordersChannel) sb.removeChannel(ordersChannel);
  ordersChannel = null;
}

function startRoastingRealtime(){
  if (roastingChannel) return;
  roastingChannel = sb
    .channel('roasting-log-realtime')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'roasting_log' }, async () => {
      const { data, error } = await sb.from('roasting_log').select('*').order('created_at', { ascending: false });
      if (error) return uiError('Load roasts (RT)', error);
      allRoasts = data || [];
      renderTable();
    })
    .subscribe();
}
function stopRoastingRealtime(){
  if (roastingChannel) sb.removeChannel(roastingChannel);
  roastingChannel = null;
}

/* =================== Orders =================== */
function renderOrders(rows) {
  const tb = $('#ordersTbody');
  tb.innerHTML = '';
  rows.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(r.created_at).toLocaleString()}</td>
      <td>${r.order_number || ''}</td>
      <td>${[r.billing_first_name, r.billing_last_name].filter(Boolean).join(" ")}</td>
      <td>${r.product_name || ''}</td>
      <td>${r.profile || ''}</td>
      <td>${r.starting_weight_grams || ''} g</td>
      <td>${r.notes || ''}</td>
      <td>${r.status || 'pending'}</td>
      <td><button class="btn small accent2" data-id="${r.id}">Start Roast</button></td>
    `;

    tr.querySelector('button').onclick = () => {
      const grams = (() => {
        const v = (r.starting_weight_grams ?? '').toString();
        const n = parseFloat(v.replace(/[^\d.]/g, ''));
        return isNaN(n) ? '' : n;
      })();

      active.bean = r.product_name || '';
      active.profile = r.profile || '';
      active.startWeight = grams;
      active.notes = `[Order ${r.order_number}] ${r.notes || ''}`;
      active.orderId = r.id;

      bindActiveToUI();
      showTab('active');

      sb.from('order_queue').update({ status: 'roasting' }).eq('id', r.id)
        .then(({ error }) => { if (error) uiError('Mark roasting', error); });
    };

    tb.appendChild(tr);
  });
}

async function loadOrders(){
  const { data, error } = await sb
    .from('order_queue')
    .select(`
      id, created_at, order_number,
      billing_first_name, billing_last_name,
      product_name, profile, starting_weight_grams, status
    `)
    .neq('status', 'completed')
    .order('created_at', { ascending: false });

  if (error) return uiError('Load orders', error);
  renderOrders(data || []);
}

/* =================== Roasting log storage =================== */
let storageMode = 'supabase';
const db = {
  async all() {
    const { data, error } = await sb.from('roasting_log').select('*').order('created_at', { ascending: false });
    if (error) { uiError('Load roasts', error); return []; }
    return data;
  },
  async put(roast) {
    const { error } = await sb.from('roasting_log').upsert(roast, { onConflict: 'id' });
    if (error) uiError('Save roast', error);
  },
  async delete(id) {
    const { error } = await sb.from('roasting_log').delete().eq('id', id);
    if (error) uiError('Delete roast', error);
  }
};

/* =================== Active roast state =================== */
let active = {};
let allRoasts = [];

function newActive(){
  active = {
    id: 'B' + Date.now(),
    date: todayStr(),
    roaster: '', bean: '', profile: '', notes: '',
    startWeight: '', chargeTemp: '',
    startTime: '', firstCrackTime: '', firstCrackTemp: '',
    secondCrackTime: '', secondCrackTemp: '',
    endTime: '', endWeight: '', endTemp: '',
    orderId: null
  };
  bindActiveToUI();
  $('#status-pill').textContent = 'Ready';
  $('#deltaHint').textContent = '';
}

function bindActiveToUI(){
  $('#roasterName').value = active.roaster || '';
  $('#beanName').value = active.bean || '';
  $('#profile').value = active.profile || '';
  $('#notes').value = active.notes || '';
  $('#startWeight').value = active.startWeight || '';
  $('#chargeTemp').value = active.chargeTemp || '';
  $('#startTime').value = fmtTime(active.startTime);
  $('#firstCrackTime').value = fmtTime(active.firstCrackTime);
  $('#secondCrackTime').value = fmtTime(active.secondCrackTime);
  $('#endTime').value = fmtTime(active.endTime);
  $('#firstCrackTemp').value = active.firstCrackTemp || '';
  $('#secondCrackTemp').value = active.secondCrackTemp || '';
  $('#endWeight').value = active.endWeight || '';
  $('#endTemp').value = active.endTemp || '';
  updateDeltaHint();
}

function wireActiveInputs(){
  $('#roasterName').oninput = e => active.roaster = e.target.value;
  $('#beanName').oninput   = e => active.bean    = e.target.value;
  $('#profile').oninput    = e => active.profile = e.target.value;
  $('#notes').oninput      = e => active.notes   = e.target.value;
  $('#startWeight').oninput= e => { active.startWeight = e.target.value; updateDeltaHint(); };
  $('#chargeTemp').oninput = e => active.chargeTemp = e.target.value;
  $('#firstCrackTemp').oninput  = e => active.firstCrackTemp  = e.target.value;
  $('#secondCrackTemp').oninput = e => active.secondCrackTemp = e.target.value;
  $('#endWeight').oninput  = e => { active.endWeight = e.target.value; updateDeltaHint(); };
  $('#endTemp').oninput    = e => active.endTemp = e.target.value;
}

function updateDeltaHint(){
  const s = parseFloat(active.startWeight||'');
  const e = parseFloat(active.endWeight||'');
  if(!isNaN(s) && !isNaN(e) && s>0){
    const loss = ((s - e) / s) * 100;
    $('#deltaHint').textContent = `Weight loss: ${loss.toFixed(1)}%`;
  } else {
    $('#deltaHint').textContent = '';
  }
}

/* =================== Buttons =================== */
$('#btnStart').onclick = () => { active.startTime = nowISO(); $('#startTime').value = fmtTime(active.startTime); statusPill.textContent = 'Roast started'; };
$('#btnFC').onclick    = () => { active.firstCrackTime = nowISO(); $('#firstCrackTime').value = fmtTime(active.firstCrackTime); statusPill.textContent = '1st crack logged'; };
$('#btnSC').onclick    = () => { active.secondCrackTime = nowISO(); $('#secondCrackTime').value = fmtTime(active.secondCrackTime); statusPill.textContent = '2nd crack logged'; };
$('#btnEnd').onclick   = () => { active.endTime = nowISO(); $('#endTime').value = fmtTime(active.endTime); statusPill.textContent = 'Finished'; };
$('#btnReset').onclick = () => newActive();

$('#btnSave').onclick = async () => {
  if (!active.startTime) return alert('Tap Start to begin the roast.');

  const roastToSave = {
    ...active,
    startTime: active.startTime || null,
    firstCrackTime: active.firstCrackTime || null,
    secondCrackTime: active.secondCrackTime || null,
    endTime: active.endTime || null,
    orderId: active.orderId || null  // avoid invalid UUID error
  };

  try {
    await db.put(roastToSave); // ✅ use cleaned object
    allRoasts = await db.all();
    renderTable();

    if (roastToSave.orderId) {
      const { error } = await sb
        .from('order_queue')
        .update({ status: 'completed' })
        .eq('id', roastToSave.orderId);
      if (error) uiError('Complete order', error);
    }

    statusPill.textContent = `Saved ${roastToSave.id} • Storage: ${storageMode} • Records: ${allRoasts.length}`;
    newActive();
    loadOrders();
  } catch (err) {
    uiError('Save', err);
  }
};

/* =================== Log table =================== */
function tdEditable(roast, key, placeholder=''){
  const val = roast[key] ?? '';
  const show = (k, v) => (k.toLowerCase().includes('time') ? fmtTime(v) : (v ?? ''));
  return `<td contenteditable="true" data-id="${roast.id}" data-key="${key}" placeholder="${placeholder}">${show(key,val)}</td>`;
}
function computeLossPct(r){
  const s = parseFloat(r.startWeight||''); const e = parseFloat(r.endWeight||'');
  return (!isNaN(s) && !isNaN(e) && s>0) ? (((s-e)/s)*100).toFixed(1) : '';
}
function renderTable(){
  const tbody = $('#logTbody');
  tbody.innerHTML = '';
  const rows = [...allRoasts].sort((a,b)=>(b.id>a.id?1:-1));

  for(const r of rows){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.date||''}</td>
      ${tdEditable(r,'roaster')}
      ${tdEditable(r,'bean')}
      <td>${fmtTime(r.startTime)||''}</td>
      <td>${fmtTime(r.firstCrackTime)||''} ${r.firstCrackTemp?`/ ${r.firstCrackTemp}°C`:''}</td>
      <td>${fmtTime(r.secondCrackTime)||''} ${r.secondCrackTemp?`/ ${r.secondCrackTemp}°C`:''}</td>
      <td>${fmtTime(r.endTime)||''}</td>
      ${tdEditable(r,'startWeight')}
      ${tdEditable(r,'endWeight')}
      ${tdEditable(r,'endTemp')}
      <td>${computeLossPct(r)}</td>
      ${tdEditable(r,'notes','tap to edit')}
      <td><button class="btn small danger del" data-id="${r.id}">Delete</button></td>
    `;
    tr.addEventListener('click', (e)=>{
      const isDelete = e.target?.classList?.contains('del');
      const isEditable = e.target?.getAttribute?.('contenteditable') === 'true';
      if (isDelete || isEditable) return;
      openDetail(r.id);
    });
    tbody.appendChild(tr);
  }

  tbody.querySelectorAll('td[contenteditable="true"]').forEach(td=>{
    td.addEventListener('blur', async ()=>{
      const id = td.getAttribute('data-id');
      const key = td.getAttribute('data-key');
      const roast = allRoasts.find(x=>x.id===id);
      let val = td.textContent.trim();
      if(['startWeight','endWeight','chargeTemp','firstCrackTemp','secondCrackTemp','endTemp'].includes(key)){
        val = val.replace(/[^\d.]/g,'');
      }
      roast[key] = val;
      await db.put(roast);
      allRoasts = await db.all();
      renderTable();
    }, {passive:true});
  });

  tbody.querySelectorAll('.del').forEach(btn=>{
    btn.onclick = async () => {
      const id = btn.getAttribute('data-id');
      if(confirm(`Delete roast ${id}?`)){
        await db.delete(id);
        allRoasts = await db.all();
        renderTable();
      }
    };
  });
}

/* =================== Detail modal (unchanged logic) =================== */
let selectedRoast = null;
const M = (id) => document.getElementById(id);
const setIf = (id, v) => { const el=M(id); if (el) el.value = v ?? ''; };
const getVal = (id) => (M(id)?.value ?? '').trim();

function isoFromFlexible(input){
  const v = (input||'').trim();
  if (!v) return '';
  if (!isNaN(Date.parse(v))) return new Date(v).toISOString();
  const hhmm = /^(\d{1,2}):(\d{2})(?::(\d{2}))?$/;
  const m = v.match(hhmm);
  if (m){
    const d = new Date();
    d.setHours(parseInt(m[1],10), parseInt(m[2],10), parseInt(m[3]||'0',10), 0);
    return d.toISOString();
  }
  const d = new Date(v);
  return isNaN(d) ? '' : d.toISOString();
}

function openDetail(roastId){
  selectedRoast = allRoasts.find(r => r.id === roastId);
  if (!selectedRoast) return;
  M('detailId').textContent = selectedRoast.id;
  M('detailStorage').textContent = `Storage: ${storageMode}`;
  setIf('d_date', selectedRoast.date || new Date().toLocaleDateString());
  setIf('d_roaster', selectedRoast.roaster);
  setIf('d_bean', selectedRoast.bean);
  setIf('d_profile', selectedRoast.profile);
  setIf('d_startWeight', selectedRoast.startWeight);
  setIf('d_chargeTemp', selectedRoast.chargeTemp);
  setIf('d_startTime', selectedRoast.startTime);
  setIf('d_firstCrackTime', selectedRoast.firstCrackTime);
  setIf('d_firstCrackTemp', selectedRoast.firstCrackTemp);
  setIf('d_secondCrackTime', selectedRoast.secondCrackTime);
  setIf('d_secondCrackTemp', selectedRoast.secondCrackTemp);
  setIf('d_endTime', selectedRoast.endTime);
  setIf('d_endWeight', selectedRoast.endWeight);
  setIf('d_endTemp', selectedRoast.endTemp);
  setIf('d_notes', selectedRoast.notes);
  M('detailModal').style.display = 'flex';
}

async function saveDetail(){
  if (!selectedRoast) return;
  selectedRoast.date = getVal('d_date');
  selectedRoast.roaster = getVal('d_roaster');
  selectedRoast.bean = getVal('d_bean');
  selectedRoast.profile = getVal('d_profile');
  selectedRoast.startWeight = getVal('d_startWeight');
  selectedRoast.chargeTemp = getVal('d_chargeTemp');
  selectedRoast.startTime = isoFromFlexible(getVal('d_startTime')) || null;
  selectedRoast.firstCrackTime = isoFromFlexible(getVal('d_firstCrackTime')) || null;
  selectedRoast.firstCrackTemp = getVal('d_firstCrackTemp');
  selectedRoast.secondCrackTime = isoFromFlexible(getVal('d_secondCrackTime')) || null;
  selectedRoast.secondCrackTemp = getVal('d_secondCrackTemp');
  selectedRoast.endTime = isoFromFlexible(getVal('d_endTime')) || null;
  selectedRoast.endWeight = getVal('d_endWeight');
  selectedRoast.endTemp = getVal('d_endTemp');
  selectedRoast.notes = getVal('d_notes');

  await db.put(selectedRoast);
  allRoasts = await db.all();
  renderTable();
  statusPill.textContent = `Saved ${selectedRoast.id} • Storage: ${storageMode} • Records: ${allRoasts.length}`;
}
function closeDetail(){ M('detailModal').style.display = 'none'; selectedRoast = null; }

M('detailClose').onclick = closeDetail;
M('detailSave').onclick = async () => { await saveDetail(); closeDetail(); };
M('detailDelete').onclick = async () => {
  if (!selectedRoast) return;
  if (confirm(`Delete roast ${selectedRoast.id}?`)) {
    await db.delete(selectedRoast.id);
    allRoasts = await db.all();
    renderTable();
    closeDetail();
  }
};
M('detailDuplicate').onclick = async () => {
  if (!selectedRoast) return;
  const copy = JSON.parse(JSON.stringify(selectedRoast));
  copy.id = 'B' + Date.now();
  copy.date = new Date().toLocaleDateString();
  await db.put(copy);
  allRoasts = await db.all();
  renderTable();
  statusPill.textContent = `Duplicated ${selectedRoast.id} → ${copy.id} • Records: ${allRoasts.length}`;
};
M('d_setStartNow').onclick = () => { M('d_startTime').value = nowISO(); };
M('d_setFCNow').onclick   = () => { M('d_firstCrackTime').value = nowISO(); };
M('d_setSCNow').onclick   = () => { M('d_secondCrackTime').value = nowISO(); };
M('d_setEndNow').onclick  = () => { M('d_endTime').value = nowISO(); };

/* =================== CSV, tabs (unchanged) =================== */
// … keep your CSV code exactly as-is …

$$('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    const name = t.getAttribute('data-tab');
    if(!name) return;
    $$('.tab').forEach(x=>x.classList.toggle('active', x===t));
    $('#tab-active').style.display = name==='active'?'block':'none';
    $('#tab-log').style.display    = name==='log'?'block':'none';
  });
});
ordersTabButton.addEventListener('click', () => {
  $$('.tab').forEach(x=>x.classList.remove('active'));
  ordersTabButton.classList.add('active');
  showTab('orders');
});

/* =================== Auth wiring =================== */
btnSignIn.onclick = async () => {
  const email = prompt("Enter your work email to sign in:");
  if (!email) return;
  const { error } = await sb.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
  if (error) return uiError('Sign-in', error);
  alert("Check your email for a sign-in link. After you tap it, return to this page.");
};

btnSignOut.addEventListener('click', async () => {
  const { error } = await sb.auth.signOut();
  if (error) return uiError('Sign-out', error);
  // hard reset the UI to avoid any lingering realtime handlers
  stopOrdersRealtime();
  stopRoastingRealtime();
  location.reload();
});

sb.auth.onAuthStateChange(async (_event, session) => {
  if (session?.user) {
    authStatus.textContent = "Signed in: " + (session.user.email || 'user');
    btnSignIn.style.display = 'none';
    btnSignOut.style.display = '';
    startOrdersRealtime();
    startRoastingRealtime();
    await loadOrders();
    const { data, error } = await sb.from('roasting_log').select('*').order('created_at', { ascending: false });
    if (error) uiError('Load roasts', error);
    allRoasts = data || [];
    renderTable();
  } else {
    authStatus.textContent = "Not signed in";
    btnSignIn.style.display = '';
    btnSignOut.style.display = 'none';
    stopOrdersRealtime();
    stopRoastingRealtime();
    clearOrders();
    allRoasts = [];
    renderTable();
  }
});

/* =================== Misc =================== */
function clearOrders(){ $('#ordersTbody').innerHTML=''; }

async function ensurePersistence(){
  if (navigator.storage && navigator.storage.persist) {
    try {
      if (!(await navigator.storage.persisted())) await navigator.storage.persist();
      statusPill.textContent = `Storage: supabase (persisted)`;
      return;
    } catch {}
  }
  statusPill.textContent = `Storage: supabase`;
}

/* =================== Single boot =================== */
(async function init(){
  newActive();
  wireActiveInputs();

  const { data: { session } } = await sb.auth.getSession();
  if (session?.user) {
    authStatus.textContent = "Signed in: " + (session.user.email || 'user');
    btnSignIn.style.display = 'none';
    btnSignOut.style.display = '';
    startOrdersRealtime();
    startRoastingRealtime();
    await loadOrders();
    const { data, error } = await sb.from('roasting_log').select('*').order('created_at', { ascending: false });
    if (error) uiError('Load roasts', error);
    allRoasts = data || [];
    renderTable();
  } else {
    authStatus.textContent = "Not signed in";
    btnSignIn.style.display = '';
    btnSignOut.style.display = 'none';
    renderTable();
  }

  await ensurePersistence();
  statusPill.textContent += ` • Records: ${allRoasts.length}`;
})();

/* Optional: catch any stray JS errors to the pill */
window.addEventListener('error', (e) => uiError('Runtime', e.error || e.message));
</script>

</body>
</html>
