<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Roast Analytics</title>
  <style>
    :root {
      --bg:#0f1115; --card:#151823; --muted:#8b92a6;
      --text:#e8ecf3; --accent:#5cc8ff; --accent2:#52d39b;
    }
    body { margin:0; background:var(--bg); color:var(--text);
           font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    .wrap { max-width:1100px; margin:0 auto; padding:20px; }
    h1 { margin-bottom:20px; }
    .filter-bar {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    select, input[type="date"] {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--muted);
      border-radius: 6px;
      padding: 6px 10px;
    }
    .chart-card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }
    canvas { width: 100% !important; height: 400px !important; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Roast Analytics</h1>

  <!-- Filters -->
  <div class="filter-bar">
    <label for="beanFilter">Bean:</label>
    <select id="beanFilter"></select>

    <label for="fromDate">From:</label>
    <input type="date" id="fromDate" />

    <label for="toDate">To:</label>
    <input type="date" id="toDate" />

    <button id="applyFilters">Apply</button>
  </div>

  <!-- Charts -->
  <div class="chart-card"><canvas id="beanAverages"></canvas></div>
  <div class="chart-card"><canvas id="weightLossVsDev"></canvas></div>
  <div class="chart-card"><canvas id="calendarHeatmap"></canvas></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js";

  const SUPABASE_URL = "https://spdzolnriqpyoupnwdvq.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwZHpvbG5yaXFweW91cG53ZHZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMjU4NTUsImV4cCI6MjA3MDYwMTg1NX0.uYH2jwqCGCqW5Qo7FpuwQg6Z7kPbotVuLpjJm8xA-3M";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  // --- AUTH HANDLING ---
  let { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    const { data } = await new Promise(resolve => {
      const { data: listener } = supabase.auth.onAuthStateChange((_event, session) => {
        resolve({ data: { session } });
        listener.subscription.unsubscribe();
      });
    });
    session = data.session;
  }
  if (!session) {
    document.body.innerHTML = "<div class='wrap'><h2>Please log in via the Roasting Log app first.</h2></div>";
    throw new Error("No session");
  }

  // --- FILTER UI ---
  const beanSelect = document.getElementById("beanFilter");
  const fromDateInput = document.getElementById("fromDate");
  const toDateInput = document.getElementById("toDate");
  const applyBtn = document.getElementById("applyFilters");

  async function loadBeanFilter(){
    const { data, error } = await supabase.from("roasting_log").select("bean_name");
    if(error){ console.error(error); return; }
    const uniqueBeans = [...new Set(data.map(r => r.bean_name).filter(Boolean))];
    beanSelect.innerHTML = "<option value=''>All Beans</option>" + 
      uniqueBeans.map(b => `<option value="${b}">${b}</option>`).join("");
  }

  applyBtn.addEventListener("click", ()=> {
    fetchAndRender(beanSelect.value, fromDateInput.value, toDateInput.value);
  });

  // --- FETCH + RENDER ---
  async function fetchAndRender(bean, fromDate, toDate){
    let query = supabase.from("roasting_log").select("*");
    if(bean) query = query.eq("bean_name", bean);
    if(fromDate) query = query.gte("roast_date", fromDate);
    if(toDate) query = query.lte("roast_date", toDate);

    const { data, error } = await query;
    if(error){ console.error(error); return; }

    renderCharts(data);
  }

  // --- CHART RENDERERS ---
  function renderCharts(roasts){
    // Destroy existing if any
    if(window.beanAveragesChart) window.beanAveragesChart.destroy();
    if(window.weightLossChart) window.weightLossChart.destroy();
    if(window.calendarChart) window.calendarChart.destroy();

    // 1. Bean averages
    const grouped = {};
    for(const r of roasts){
      if(!grouped[r.bean_name]) grouped[r.bean_name] = [];
      grouped[r.bean_name].push(r);
    }
    const labels = Object.keys(grouped);
    const avgTimes = labels.map(b => avg(grouped[b].map(r => r.roast_time)));
    const avgDev = labels.map(b => avg(grouped[b].map(r => r.dev_percent)));
    window.beanAveragesChart = new Chart(document.getElementById("beanAverages"), {
      type:"bar",
      data:{
        labels,
        datasets:[
          { label:"Avg Roast Time (s)", data:avgTimes, backgroundColor: "#5cc8ff" },
          { label:"Avg Dev %", data:avgDev, backgroundColor: "#52d39b" }
        ]
      },
      options:{ responsive:true, plugins:{ title:{ display:true, text:"Bean Averages" } } }
    });

    // 2. Weight loss vs dev scatter
    const scatterData = roasts.map(r=>({x:r.dev_percent,y:r.weight_loss}));
    window.weightLossChart = new Chart(document.getElementById("weightLossVsDev"), {
      type:"scatter",
      data:{ datasets:[{ label:"Roasts", data:scatterData, backgroundColor:"#ffb656" }]},
      options:{ plugins:{ title:{ display:true, text:"Weight Loss vs Dev%" } } }
    });

    // 3. Calendar heatmap (simplified bar per day)
    const perDay = {};
    for(const r of roasts){
      const d = r.roast_date?.split("T")[0];
      if(!d) continue;
      perDay[d] = (perDay[d]||0)+1;
    }
    const calLabels = Object.keys(perDay).sort();
    const calCounts = calLabels.map(d=>perDay[d]);
    window.calendarChart = new Chart(document.getElementById("calendarHeatmap"), {
      type:"bar",
      data:{ labels:calLabels, datasets:[{ label:"Roasts", data:calCounts, backgroundColor:"#8b92a6" }] },
      options:{ plugins:{ title:{ display:true, text:"Roasts per Day" } } }
    });
  }

  function avg(arr){
    return arr.length ? arr.reduce((a,b)=>a+(b||0),0)/arr.length : 0;
  }

  // --- INIT ---
  await loadBeanFilter();
  await fetchAndRender(); // initial load (all beans, all time)

  // --- Cleanup ---
  window.addEventListener("beforeunload", () => {
    supabase.removeAllChannels();
  });
</script>
</body>
</html>
